{% extends "base.html" %}


{% block navbar %}
  {% include 'partials/global/admin_navbar.html' %}
{% endblock %}


{% block container %}

<script src="{{ url_for('static', filename='js/Chart.bundle.js') }}"></script>


<div class="row">
  <div class="col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1">
   <h2>Dashboard</h2>
   
   <h4>Luggage by day:</h4>
   <div class="">
	   
	     <div id="monthButtonsContainer">
	       <ul class="pagination">
		     </ul>
	     </div>
	     <div id="monthlyChartContainer">
		    <canvas id="myChart" width="400" height="150"></canvas>
		   </div>
		 
	 </div>
	 
	 <h4>Luggage by hours:</h4>
   <div class="">
     
       <div id="hourlyChartContainer">
        <canvas id="myHourlyChart" width="400" height="150"></canvas>
       </div>
     
   </div>
	
   <h4><b>Summary:</b></h4>
   
   <table class="table table-bordered table-hover table-striped table-responsive tablesorter">
      <thead>
        <tr>
          <th>Date</th>
          <th>First Store</th>
          <th>Last Store</th>
          <th>Luggage time (from storing to closing)</th>
          <th>Logs per day</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Average</td>
          <td>{{ info.first_store }}</td>
          <td>{{ info.last_store }}</td>
          <td>{{ info.luggage_time }}</td>
          <td>{{ info.count_store }}</td>
        </tr>
      </tbody>
   </table>
   <h4>Extra information:</h4>
    
    <table id="open-tickets" class="table table-bordered table-hover table-striped table-responsive tablesorter">
      <thead>
        <tr>
          <th>Date</th>
          <th>First Store</th>
          <th>Last Store</th>
          <th>Luggage time (from storing to closing)</th>
          <th>Logs per day</th>
        </tr>
      </thead>
      <tbody>
        {% for store in info.stores.values() %}
        <tr>
          <td>{{ store.day.strftime('%d %b %Y') }}</td>
          <td>{{ store.first }}</td>
          <td>{{ store.last }}</td>
          <td>{{ store.diff }}</td>
          <td>{{ store.count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    
  </div>
</div>


<script>
/**
 * We print chart using Charts.js: http://www.chartjs.org/docs/latest/
 **/

var ctx = document.getElementById("myChart");

var dataByMonths = {}

var dataByHours = {}

function addDataToMonth(month, day, value) {
	if (!dataByMonths[month]) {
    dataByMonths[month] = {}  
	}
	dataByMonths[month][day] = value;
	
}

function sortObject(obj) {
    return Object.keys(obj).sort().reduce(function (result, key) {
        result[key] = obj[key];
        return result;
    }, {});
}

function sortDates(a, b) {
  a = new Date(a);
  b = new Date(b);
  if (a < b) {
    return -1;
  } else if (a > b) {
    return 1;
  } else {
    return 0;
  }
}

// We load values from luggage-by-day
{% for store in info.stores.values() %}

	var month = "{{store.day.strftime('%b %Y')}}";
	var day = {{store.day.strftime('%d')}};
	var count = {{ store.count }};
	
	addDataToMonth(month, day, count);

{% endfor %}

//We load values from luggage-by-hour
{% for store in info.stores_by_hour.values() %}

  var hour = {{store.hour}};
  var count = {{ store.count }};
  
  dataByHours[hour] = count;

{% endfor %}

function createMonthlyChart(month) {
	// remove any previous chart
	$("#monthlyChartContainer").html("");
	$("#monthlyChartContainer").append('<canvas id="myChart" width="400" height="150"></canvas>');
	var ctx = document.getElementById("myChart");

	var dataMonth = sortObject(dataByMonths[month]);
	
	var color = 'rgba(255, 99, 132, 0.2)';
	var borderColor = 'rgba(255, 99, 132, 1)';
	
	createChart(ctx, Object.keys(dataMonth), Object.values(dataMonth), '# Logs by day ' + month, color, borderColor);
	
}

function createChartByHour() {
	  // remove any previous chart
	  $("#hourlyChartContainer").html("");
	  $("#hourlyChartContainer").append('<canvas id="myHourlyChart" width="400" height="150"></canvas>');
	  var ctx = document.getElementById("myHourlyChart");

	  for (var i = 0; i<24; i++) {
		  if ( !dataByHours[i] ) {
			  dataByHours[i] = 0;
		  }
	  }
	  var dataHours = sortObject(dataByHours);
	  
	  var color = 'rgba(255, 215, 0, 0.2)';
	  var borderColor = 'rgba(255, 215, 0, 1)';
	  
	  createChart(ctx, Object.keys(dataHours), Object.values(dataHours), '# Logs by hour', color, borderColor);
	  
	}

function createChart(ctx, labels, data, title, color, borderColor) {
	
  var myChart = new Chart(ctx, {
      type: 'bar',

      data: {
          labels: labels,
          datasets: [{
              label: title,
              data: data,
              backgroundColor: color,
              borderColor: borderColor,
              borderWidth: 1
          }]
      },
      options: {
          scales: {
        	  yAxes: [{
                  ticks: {
                	  beginAtZero: true,
                    callback: function(value) {if (value % 1 === 0) {return value;}}
                  }
              }]
          }
      }
  });
  
}


function createMonthButtons() {
	var currentMonths = Object.keys(dataByMonths);
	
	currentMonths.sort(sortDates);
	
	for (var i in currentMonths) {
		$("#monthButtonsContainer ul").append('<li><a class="showChartMonthly">' + currentMonths[i] + '</a></li>');

	}
	$(".showChartMonthly").on("click", function(event) {
		$("#monthButtonsContainer li").removeClass("active");
		$(event.target).parent("li").addClass("active");
		var month = $(event.target).html();
		createMonthlyChart(month);
	});
	
	if (currentMonths.length > 0) {
		var lastMonth = currentMonths[currentMonths.length - 1]
		createMonthlyChart(lastMonth);
		$("#monthButtonsContainer li:last-child").addClass("active");
	}
	
}

createMonthButtons();

createChartByHour();

</script>

{% endblock %}