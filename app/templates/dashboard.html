{% extends "base.html" %}


{% block extra_head %}

<script src="{{ url_for('static', filename='js/Chart.bundle.js') }}"></script>

<!-- jQuery Datatables -->
<script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js" type="text/javascript"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.13/sorting/time.js" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css">
<script src="{{ url_for('static', filename='js/dashboard-information.js') }}"></script>

{% endblock %}

{% block navbar %}
  {% include 'partials/global/admin_navbar.html' %}
{% endblock %}


{% block container %}


<div class="row">
  <div class="col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1">
   <h2>Dashboard</h2>
   
   <h4>Luggage by day:</h4>
   <div class="">
	   
	     <div id="monthButtonsContainer">
	       <ul class="pagination">
		     </ul>
	     </div>
	     <div id="monthlyChartContainer">
		    <canvas id="myChart" width="400" height="150"></canvas>
		   </div>
		 
	 </div>
	 
	 <h4>Luggage by hours:</h4>
   <div class="">
       
       <div id="dailyButtonsContainer">
         <ul class="pagination">
         </ul>
       </div>
       <div id="hourlyChartContainer">
        <canvas id="myHourlyChart" width="400" height="150"></canvas>
       </div>
     
   </div>
	
   <h4><b>Summary:</b></h4>
   
   <table class="table table-bordered table-hover table-striped table-responsive tablesorter">
      <thead>
        <tr>
          <th>Date</th>
          <th>First Store</th>
          <th>Last Store</th>
          <th>Luggage time (from storing to closing)</th>
          <th>Logs per day</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Average</td>
          <td>{{ info.first_store }}</td>
          <td>{{ info.last_store }}</td>
          <td>{{ info.luggage_time }}</td>
          <td>{{ info.count_store }}</td>
        </tr>
      </tbody>
   </table>
   <h4>Extra information:</h4>
    
    <table id="extrainfo-table" class="table table-bordered table-hover table-striped table-responsive tablesorter">
      <thead>
        <tr>
          <th>Date</th>
          <th>First Store</th>
          <th>Last Store</th>
          <th>Luggage time (from storing to closing)</th>
          <th>Logs per day</th>
        </tr>
      </thead>
      <tbody>
        {% for store in info.stores.values() %}
        <tr>
          <td data-order="{{ store.day.strftime('%Y-%m-%d') }}">{{ store.day.strftime('%d %b %Y') }}</td>
          <td>{{ store.first }}</td>
          <td>{{ store.last }}</td>
          <td>{{ store.diff }}</td>
          <td>{{ store.count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    
  </div>
</div>


<script>
/**
 * We print chart using Charts.js: http://www.chartjs.org/docs/latest/
 **/

var ctx = document.getElementById("myChart");

var dataByMonths = {}

var dataByHoursGeneral = {}

function addDataToMonth(month, day, value, hours) {
	if (!dataByMonths[month]) {
    dataByMonths[month] = {}  
	}
	dataByMonths[month][day] = {
			value: value,
			hours: hours
	};
	
}

function sortObject(obj) {
    return Object.keys(obj).sort().reduce(function (result, key) {
        result[key] = obj[key];
        return result;
    }, {});
}

function sortDates(a, b) {
  a = new Date(a);
  b = new Date(b);
  if (a < b) {
    return -1;
  } else if (a > b) {
    return 1;
  } else {
    return 0;
  }
}

// We load values from luggage-by-day
{% for store in info.stores.values() %}

	var month = "{{store.day.strftime('%b %Y')}}";
	var day = {{store.day.strftime('%d')}};
	var count = {{ store.count }};
	var hour = {{ store.hours }};
	
	addDataToMonth(month, day, count, hour);

{% endfor %}

//We load values from luggage-by-hour
{% for store in info.stores_by_hour.values() %}

  var hour = {{store.hour}};
  var count = {{ store.count }};
  
  dataByHoursGeneral[hour] = count;

{% endfor %}

function createMonthlyChart(month) {
	// remove any previous chart
	$("#monthlyChartContainer").html("");
	$("#monthlyChartContainer").append('<canvas id="myChart" width="400" height="150"></canvas>');
	var ctx = document.getElementById("myChart");

	var dataMonth = sortObject(dataByMonths[month]);
	
	var color = 'rgba(255, 99, 132, 0.2)';
	var borderColor = 'rgba(255, 99, 132, 1)';
	var values = [];
	var data = Object.values(dataMonth)
	for (var i in data) {
		values.push(data[i].value)
	}
	createDailyButtons(dataMonth);
	
	createChart(ctx, Object.keys(dataMonth), values, '# Logs by day ' + month, color, borderColor);
	
}

function createChartByHour(month, day) {
	  // remove any previous chart
	  $("#hourlyChartContainer").html("");
	  $("#hourlyChartContainer").append('<canvas id="myHourlyChart" width="400" height="150"></canvas>');
	  var ctx = document.getElementById("myHourlyChart");

	  var dataByHours = {}
	  
	  var dataMonth = sortObject(dataByMonths[month]);
	  var hoursArray = dataMonth[day].hours;
	  
	  for (var i = 0; i<24; i++) {
      if ( !dataByHours[i] ) {
        dataByHours[i] = 0;
      }
    }
	  for (var i in hoursArray) {
		  var key = hoursArray[i];
	    dataByHours[key] += 1;
	  }
	  
	  var title = '# Logs by hour ' + day + " " + month;
	  var color = 'rgba(255, 215, 0, 0.2)';
	  var borderColor = 'rgba(255, 215, 0, 1)';
	  
	  createChart(ctx, Object.keys(dataByHours), Object.values(dataByHours), title, color, borderColor);
	  
	}

function createChart(ctx, labels, data, title, color, borderColor) {
	
  var myChart = new Chart(ctx, {
      type: 'bar',

      data: {
          labels: labels,
          datasets: [{
              label: title,
              data: data,
              backgroundColor: color,
              borderColor: borderColor,
              borderWidth: 1
          }]
      },
      options: {
          scales: {
        	  yAxes: [{
                  ticks: {
                	  beginAtZero: true,
                    callback: function(value) {if (value % 1 === 0) {return value;}}
                  }
              }]
          }
      }
  });
  
}


function createMonthButtons() {
	var currentMonths = Object.keys(dataByMonths);
	
	currentMonths.sort(sortDates);
	
	for (var i in currentMonths) {
		$("#monthButtonsContainer ul").append('<li><a class="showChartMonthly">' + currentMonths[i] + '</a></li>');

	}
	$(".showChartMonthly").on("click", function(event) {
		$("#monthButtonsContainer li").removeClass("active");
		$(event.target).parent("li").addClass("active");
		var month = $(event.target).html();
		createMonthlyChart(month);
	});
	
	if (currentMonths.length > 0) {
		$("#monthButtonsContainer li:last-child").addClass("active");
		var lastMonth = currentMonths[currentMonths.length - 1];
		createMonthlyChart(lastMonth);
	}
	
}

function createDailyButtons(data) {
	$("#dailyButtonsContainer ul").html("");
  for (var i in data) {
	  $("#dailyButtonsContainer ul").append('<li><a class="showChartHourly">' + i + '</a></li>');
  }
  
  $(".showChartHourly").on("click", function(event) {
    $("#dailyButtonsContainer li").removeClass("active");
    $(event.target).parent("li").addClass("active");
    var month = $("#monthButtonsContainer .active a").html();
    var day = $(event.target).html();
    createChartByHour(month, day);
  });
  
  if (Object.values(data).length > 0) {
    $("#dailyButtonsContainer li:last-child").addClass("active");
    var month = $("#monthButtonsContainer .active a").html();
    var lastDay = null;
    var days = Object.keys(data);
    for (var i in days) {
    	lastDay = days[i];
    }
    createChartByHour(month, lastDay);
  }
  
}

createMonthButtons();


</script>

{% endblock %}